<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HEBench: Adding a New Workload to Test Harness</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HEBench
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('extend_test_harness.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Adding a New Workload to Test Harness </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md92">1. Define a workload.</a></li>
<li class="level2"><a href="#autotoc_md93">2. Declare the workload in the API Bridge.</a></li>
<li class="level2"><a href="#autotoc_md94">3. Implement workload in Test Harness.</a></li>
<li class="level2"><a href="#autotoc_md95">4. Make Test Harness aware of the new workload.</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_docsrc_examples_extend_test_harness_extend_test_harness"></a></p>
<p>Refer to <a class="el" href="glossary.html">Glossary</a> for a list of terms that will be mentioned throughout this tutorial.</p>
<p>To add a new workload to HEBench, the first step is to define it, followed by adding it into the Test Harness. Since Test Harness is the program that tests backends on workloads, if it doesn't know the workload, it will not test for it.</p>
<h2><a class="anchor" id="autotoc_md92"></a>
1. Define a workload.</h2>
<p>Defining a workload is an abstract process where the workload parameters, operations, categories, etc. are specified. The definition of a workload is the design that lives outside of HEBench.</p>
<p>See the definition of <a class="el" href="elementwise_add.html">Vector Element-wise Addition</a> workload for an example.</p>
<p>Next, once the workload is defined, HEBench must be made aware of it.</p>
<h2><a class="anchor" id="autotoc_md93"></a>
2. Declare the workload in the API Bridge.</h2>
<p>To declare the workload in the API Bridge, a new enumeration value representing the workload <b>must be appended</b> to <code>enum <a class="el" href="namespacehebench_1_1APIBridge.html#aeb7e1cd988a3ca98e5345d5bc90aa733" title="Defines all possible workloads.">hebench::APIBridge::Workload</a></code> in <code><a class="el" href="types_8h.html">hebench/api_bridge/types.h</a></code>.</p>
<p>At this point, Test Harness and any backends are able to use the workload as part of their workload description.</p>
<p>Note: make sure to change the API version values in file <code>VERSION</code> as appropriate to reflect changes in the API Bridge. Adding new workload, as explained, should only constitute a revision increase.</p>
<p>For appropriate API Bridge versioning, check <b>API Bridge Versioning General Guidelines</b> in <a class="el" href="APIBridge_overview.html">API Bridge overview</a> .</p>
<h3>(Optional) Add a C++ wrapper for the workload parameters.</h3>
<p>If the new workload requires flexible workload parameters, adding a wrapper to ease development of backends is optional, but encouraged.</p>
<p>To add a wrapper, extend class <code><a class="el" href="classhebench_1_1cpp_1_1WorkloadParams_1_1Common.html" title="Base wrapper around the flexible workload parameters.">hebench::cpp::WorkloadParams::Common</a></code> from <code>workload_params.h</code>. Check this header file for examples of other wrappers already implemented for existing workloads.</p>
<h2><a class="anchor" id="autotoc_md94"></a>
3. Implement workload in Test Harness.</h2>
<p>This step entails the addition of the workload implementation into the Test Harness.</p>
<p>There are two ways to extend the Test Harness with a new workload. Which one is used depends on how much flexibility is required for the new workload and whether it fits in the predefined category behavior. For pre-defined behavior, see the first option. For full flexibility, check the second option.</p>
<h3>Option 1: Pre-defined Category Behavior</h3>
<p>If default behavior for any of the categories (<b>Latency</b>, <b>Offline</b>, etc.) is needed, then, the new workload benchmark class can inherit from the corresponding implementation of <code>IBenchmark</code>:</p>
<ul>
<li><code><a class="el" href="classhebench_1_1TestHarness_1_1BenchmarkLatency.html" title="Base class for workload benchmarks in the latency category.">hebench::TestHarness::BenchmarkLatency</a></code> for <a class="el" href="extend_test_harness_l.html#md_docsrc_examples_extend_test_harness_extend_test_harness_l">Latency</a></li>
<li><code><a class="el" href="classhebench_1_1TestHarness_1_1BenchmarkOffline.html" title="Base class for workload benchmarks in the offline category.">hebench::TestHarness::BenchmarkOffline</a></code> for <a class="el" href="extend_test_harness_o.html#md_docsrc_examples_extend_test_harness_extend_test_harness_o">Offline</a></li>
</ul>
<p>The <code>run()</code> method has already been implemented in each of these classes to follow the default measuring methodology for the category. See the corresponding documentation on extending from each and explanation of the default flow for each category as implemented by these classes.</p>
<h3>Option 2: Full Flexibility (Advanced)</h3>
<p>For full flexibility, inherit from <code><a class="el" href="classhebench_1_1TestHarness_1_1PartialBenchmark.html" title="Base class for benchmarks.">hebench::TestHarness::PartialBenchmark</a></code> to have common implementations to trivial methods declared by interface <code>IBenchmark</code>.</p>
<p>Method <code><a class="el" href="classhebench_1_1TestHarness_1_1PartialBenchmark.html#a1c6fc45c9d1e3b38dd06d4e279f7697c" title="Initializes the partial benchmark members.">hebench::TestHarness::PartialBenchmark::init()</a></code> must be implemented to perform initialization after construction, but before the backend itself is initialized. Data loading or generation should take place in this method. Errors during initialization should be reported as exceptions derived from <code>std::exception</code>.</p>
<p>Method <code><a class="el" href="classhebench_1_1TestHarness_1_1PartialBenchmark.html#a35d1003b0e660e5a46d06d1dc5972019" title="Called automatically during initialization after the backend has been initialized.">hebench::TestHarness::PartialBenchmark::postInit()</a></code> can be overriden to provide initialization that requires the backend to already exist. Note that overrides of this method must call the base method as their first operation.</p>
<p>The implementation of method <code>IBenchmark::run()</code> is the most important since it is the implementation of the actual benchmark. For correct statistical computations of reported events during the run, make sure that events of the same type are added to the <code><a class="el" href="classhebench_1_1Utilities_1_1TimingReportEx.html">hebench::Utilities::TimingReportEx</a></code> <code>out_report</code> parameter under the same event ID, and the event which is the main benchmarking operation is clearly specified when adding the event type.</p>
<h2><a class="anchor" id="autotoc_md95"></a>
4. Make Test Harness aware of the new workload.</h2>
<p>Once the workload is implemented, the final step is to make the Test Harness aware of it.</p>
<ol type="1">
<li><p class="startli">Describe the workload.</p>
<p class="startli">To do so, first create a workload description class that derives from interface <code><a class="el" href="classhebench_1_1TestHarness_1_1PartialBenchmarkDescriptor.html" title="Provides boilerplate implementation to common methods of interface IBenchmarkDescription and implemen...">hebench::TestHarness::PartialBenchmarkDescriptor</a></code> (from header <code><a class="el" href="hebench__ibenchmark_8h.html">hebench_ibenchmark.h</a></code>) and implement all of its <b>abstract</b> methods following their interface documentation:</p><ul>
<li><code><a class="el" href="classhebench_1_1TestHarness_1_1IBenchmarkDescriptor.html#aef7abd99a012795511d39b7eb209a0ad" title="Creates the represented IBenchmark object that can perform the workload specified by the HEBench benc...">hebench::TestHarness::IBenchmarkDescriptor::createBenchmark()</a></code></li>
<li><code><a class="el" href="classhebench_1_1TestHarness_1_1IBenchmarkDescriptor.html#a47f48de7d47274a2744b0fc6ff2d83f7" title="Destroys an object returned by createBenchmark().">hebench::TestHarness::IBenchmarkDescriptor::destroyBenchmark()</a></code></li>
<li><code><a class="el" href="classhebench_1_1TestHarness_1_1PartialBenchmarkDescriptor.html#afe84fac82aa8aa8fc464b57d526e738c" title="Determines if the represented benchmark can perform the workload described by a specified HEBench ben...">hebench::TestHarness::PartialBenchmarkDescriptor::matchBenchmarkDescriptor()</a></code></li>
<li><code><a class="el" href="classhebench_1_1TestHarness_1_1PartialBenchmarkDescriptor.html#a43280ec1e56eb8f975562d4695bc334a" title="Completes the description for the matched benchmark.">hebench::TestHarness::PartialBenchmarkDescriptor::completeWorkloadDescription()</a></code></li>
</ul>
<p class="startli">Inside <code><a class="el" href="namespacehebench_1_1APIBridge.html#a7b0808f5d5a29d8c332313038ab44b94" title="Instantiates a benchmark on the backend.">createBenchmark()</a></code>, the benchmark object should be constructed and returned. The object's initialization methods will be called after construction automatically, and thus, they should not be called manually by our implementation.</p>
<p class="startli">Note that benchmark description objects should be lightweight because they will exist throughout the lifetime of the main Test Harness process.</p>
</li>
<li><p class="startli">Register workload description with the benchmark factory.</p>
<p class="startli">Next, an object of the workload description class mentioned above has to be registered with the <code><a class="el" href="classhebench_1_1TestHarness_1_1BenchmarkFactory.html">hebench::TestHarness::BenchmarkFactory</a></code> before the Test Harness starts. This ensures that the factory knows of this new workload when it is creating benchmarks. This is accomplished by calling method <code><a class="el" href="classhebench_1_1TestHarness_1_1BenchmarkFactory.html#ae6373dd5233dd909882137a91fc1a5a3" title="Registers a benchmark description object that represents one of the supported workloads.">hebench::TestHarness::BenchmarkFactory::registerSupportedBenchmark()</a></code> <em>during static initialization</em>.</p>
<p class="startli">The recommended way to do this is to define a static <code>bool</code> member in the workload description class created in the previous step, and, during declaration, initialize it with the return value of <code>BenchmarkFactory::registerSupportedBenchmark()</code> method, where the parameter for the method is a <code>shared_ptr</code> instantiation of said workload description.</p>
</li>
</ol>
<p>Once registered, <code>BenchmarkFactory</code> will call the methods in benchmark description objects to pick the right benchmark for a workload, create it, and destroy it once the benchmark completes execution.</p>
<p>For an example of registering a benchmark workload with the <code>BenchmarkFactory</code> and all the corresponding nuances, check the mechanism implementation in <code><a class="el" href="hebench__eltwiseadd__l_8h.html">hebench_eltwiseadd_l.h</a></code> and <code><a class="el" href="hebench__eltwiseadd__l_8cpp.html">hebench_eltwiseadd_l.cpp</a></code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
